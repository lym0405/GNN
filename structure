GNN/
│
├── .git/                        # Git 버전 관리
├── .gitignore                   # Git 제외 파일 설정
├── .venv/                       # Python 가상 환경 (미포함)
│
├── CACHE_GUIDE.md              # 캐시 시스템 가이드
├── COLUMN_NAME_UPDATE.md       # 컬럼명 업데이트 가이드
├── clear_cache.py              # 캐시 삭제 유틸리티
│
├── data/
│   ├── raw/  # [원본 데이터] (절대 수정 금지)
│   │   ├── posco_network_capital_consumergoods_removed_{year}.csv
│   │   │   (ye4. 개별 기업의 총매출액
    - *컬럼*
        
        tg_2024_filtered.csv
        ['업체번호', 'tg_2024_final']
        
5. 개별 기업의 소재지 (기업 간 거리가 가까울수록 거래관계일 확률이 올라감)20, 2021, 2022, 2023)
│   │   │   → 컬럼: 사업자등록번호, 거래처사업자등록번호, 총공급금액 등
│   │   │
│   │   ├── H_csr_model2.npz            # 거래 네트워크 행렬 (Sparse, 438K×438K)
│   │   ├── firm_to_idx_model2.csv      # 사업자번호 → 인덱스 매핑 (정렬 기준)
│   │   │
│   │   ├── vat_20-24_company_list_w_companyinfo_nocutoff_v3_hyundaisteel_hj.csv
│   │   │   → 전체 기업 정보 (업체번호, 사업자등록번호, 좌표, 산업코드)
│   │   │
│   │   ├── A_33.csv                    # 국가 IO 테이블 (33×33)
│   │   ├── tg_2024_filtered.csv        # 매출 데이터 (업체번호, tg_2024_final)
│   │   ├── export_estimation_value_final.csv # 수출액 (천원 단위)
│   │   ├── asset_final_2024_6차.csv     # 자산 추정
│   │   └── shock_after_P_v2.csv        # TIS 리스크 점수
│   │   
│   └── processed/  # [전처리 결과 및 모델 출력]
│       ├── disentangled_recipes.pkl    # Phase 1: 기업별 생산함수 (33차원)
│       ├── recipes_dataframe.csv       # Phase 1: 레시피 데이터프레임
│       ├── recipe_validation_report.csv # Phase 1: 레시피 검증 리포트
│       │
│       ├── B_matrix.npy                # Phase 1: B 행렬
│       ├── X_feature_matrix.npy        # Phase 2: 피처 행렬 (N×197)
│       ├── recipe_features_cache.npy   # Phase 2: 레시피 캐싱 (속도 향상)
│       ├── tis_score_normalized.npy    # Phase 2: TIS 정규화 점수
│       ├── node_embeddings_static.pt   # Phase 2: GraphSAGE 임베딩 (N×32)
│       │
│       ├── train_edges.npy             # Phase 2: Train 엣지 (80%, Data Leakage 방지)
│       └── test_edges.npy              # Phase 2: Test 엣지 (20%, 평가용)
│
├── results/                     # 실행 결과 저장 디렉토리
│   └── quick_test/              # 빠른 테스트 결과
│
├── trash/                       # (비어 있음) 임시 파일 보관
│
├── phase1/  # [Phase 1: 생산함수 추정]
│   ├── README.md                     # Phase 1 설명서
│   ├── STRUCTURE.txt                 # Phase 1 구조 문서
│   ├── requirements.txt              # Phase 1 Python 의존성
│   ├── quick_test.sh                 # Phase 1 빠른 테스트 스크립트
│   │
│   ├── generate_dummy_data.py        # 더미 데이터 생성
│   ├── main_phase1.py                # Phase 1 메인 실행 파일
│   │
│   └── src/
│       ├── b_matrix_generator.py     # BMatrixGenerator (변수명 수정 완료)
│       ├── inventory_module.py       # ZeroShotInventoryModule
│       ├── check_recipe.py           # 레시피 검증
│       └── debug_deep_dive.py        # 디버그 도구
│
├── phase2/  # [Phase 2: 정적 그래프 임베딩]
│   ├── README.md                     # Phase 2 설명서
│   ├── STRUCTURE.txt                 # Phase 2 구조 문서
│   ├── requirements.txt              # Phase 2 Python 의존성
│   ├── quick_test_phase2.sh          # Phase 2 빠른 테스트 스크립트
│   │
│   ├── main_phase2.py                # Phase 2 메인 실행 파일
│   ├── test_phase2.py                # Phase 2 테스트 스크립트
│   │
│   └── src/
│       ├── graph_builder.py          # 정적 그래프 빌더 (인덱스 정렬 수정 완료)
│       ├── GraphSAGE.py              # GraphSAGE 모델 (2-Layer SAGEConv)
│       ├── sampler.py                # 네거티브 샘플링 (컬럼명 수정 완료)
│       ├── loss.py                   # RiskAwareBCELoss
│       └── trainer.py                # 학습 루프 관리
│
├── phase3/  # [Phase 3: 링크 예측 & 평가]
│   ├── README.md                     # Phase 3 설명서
│   ├── STRUCTURE.txt                 # Phase 3 구조 문서
│   ├── FINAL_SUMMARY.txt             # Phase 3 최종 요약
│   ├── requirements.txt              # Phase 3 Python 의존성
│   │
│   ├── main.py                       # Phase 3 메인 실행 파일 (최신)
│   ├── main_old.py                   # Phase 3 이전 버전
│   ├── quick_test.py                 # 빠른 테스트
│   ├── test.py                       # 테스트 스크립트
│   ├── evaluate_comprehensive.py     # 종합 평가
│   ├── generate_temporal_networks.py # 시계열 네트워크 생성
│   │
│   └── src/
│       ├── temporal_graph_builder.py # TGN용 시계열 데이터 구축
│       ├── graphseal.py              # GraphSEAL (DGCNN 구조적 링크 예측)
│       ├── sc_tgn.py                 # Temporal Graph Network
│       ├── link_predictor.py         # 링크 예측기
│       ├── loss.py                   # 손실 함수
│       ├── trainer_alt.py            # 대체 트레이너
│       ├── hybrid_trainer.py         # 하이브리드 트레이너
│       ├── benchmarks.py             # 휴리스틱 벤치마크 (CN, AA, PA)
│       ├── metrics.py                # 평가 메트릭
│       ├── negative_sampler.py       # 네거티브 샘플러
│       └── robustness_test.py        # 강건성 테스트
│
├── phase4/  # [Phase 4: 제약 기반 최적 재배선] (설계 완료, 구현 예정)
│   ├── README.md                     # Phase 4 설명서
│   ├── PHASE4_DESIGN.md              # Phase 4 설계 문서
│   ├── requirements.txt              # Phase 4 Python 의존성
│   │
│   ├── main_phase4.py                # Phase 4 메인 실행 파일 (예정)
│   ├── evaluate_rewiring.py          # 재배선 평가 스크립트 (예정)
│   │
│   └── src/
│       ├── rewiring_optimizer.py     # 재배선 최적화 알고리즘
│       │   → Buffer 계산: f(z_v) × 1/(TIS_v + ε)
│       │   → 최종 스코어: P(u,v) × Buffer(v) - Penalty_inv
│       ├── buffer_calculator.py      # 충격완충력 계산
│       ├── penalty_calculator.py     # 재고/용량 패널티 계산
│       ├── constraint_checker.py     # 제약 조건 검증
│       └── benchmarks.py             # Greedy, Random 벤치마크
│
├── columns                      # 데이터 명세서 (텍스트)
└── structure                    # 프로젝트 구조 문서 (본 파일)

# ============================================================
# 전체 실행 플로우
# ============================================================

[Phase 1] 생산함수 추정 (phase1/main_phase1.py)
  입력: IO 테이블, H 행렬, 기업정보, 매출, 거래 데이터
  처리: BMatrixGenerator → ZeroShotInventoryModule
  출력: disentangled_recipes.pkl (기업별 33차원 생산함수)
  
[Phase 2] 정적 그래프 임베딩 (phase2/main_phase2.py)
  입력: Phase 1 출력 + 매출/수출/자산/TIS + H 행렬
  처리: 
    - graph_builder.py: 정적 그래프 구축 및 인덱스 정렬
    - 피처 생성: 재무 + 좌표 + TIS + 산업분류 + 레시피
    - Train/Test 엣지 분할
    - GraphSAGE 학습
    - sampler.py: 네거티브 샘플링
    - loss.py: TIS 기반 손실 함수
  출력: 
    - node_embeddings_static.pt (노드 임베딩)
    - train_edges.npy (학습용 엣지)
    - test_edges.npy (평가용 엣지)

[Phase 3] 링크 예측 & 평가 (phase3/main.py)
  입력: Phase 2 임베딩 + 엣지 데이터
  처리: 
    - GraphSEAL (DGCNN): 서브그래프 구조 학습
    - 시계열 그래프 분석 (temporal_graph_builder.py)
    - 벤치마크: Common Neighbors, Adamic-Adar 등
  출력: 
    - 학습된 링크 예측 모델
    - link_predictions.npy (링크 예측 확률)
  평가: ROC-AUC, Precision@K

[Phase 4] 제약 기반 최적 재배선 (phase4/main_phase4.py) 🆕 설계 완료
  입력: 
    - Phase 3 링크 예측 확률
    - Phase 2 TIS 점수
    - Phase 1 생산함수 (레시피)
    - 재무 데이터 (매출, 자산, 영업이익)
    - 단절 시나리오 (관세 타격 대상)
  처리:
    - 충격완충력 계산: Buffer(v) = f(z_v) × 1/(TIS_v + ε)
    - 최종 스코어링: Score = P(u,v) × Buffer(v) - Penalty_inv
    - 제약 조건 기반 재배선 선택
  출력:
    - rewiring_map.pkl (재배선 매핑)
    - H_prime_rewired.npz (재배선된 네트워크)
    - buffer_scores.npy (충격완충력)
  벤치마크: Greedy, Random

[Phase 5] 리질리언스 시뮬레이션 (phase5/main_phase5.py) 🆕 예정
  입력: 
    - H_original (원본 네트워크)
    - H_prime_rewired (재배선 네트워크)
  처리:
    - 충격 전파 시뮬레이션
    - 경제적 손실 계산
  출력:
    - 원본 vs 재배선 경제적 손실 비교
    - 시뮬레이션 결과 리포트

# ============================================================
# 주요 구성 요소 설명
# ============================================================

[데이터 구조]
- 노드(기업): 438,946개
- 엣지(거래): 수백만 개
- 시계열: 2020-2024년 (5개년)

[Phase 1 - 생산함수 추정]
- BMatrixGenerator: B 행렬 생성 (기업별 산업별 거래 비중)
- ZeroShotInventoryModule: 생산함수 추정
- 출력: 33차원 레시피 벡터 (국가 IO 테이블 기준)

[Phase 2 - 그래프 임베딩]
- graph_builder.py: 정적 그래프 구축
  * 인덱스 정렬: firm_to_idx_model2.csv 기준으로 정렬
  * NaN 처리: np.nan_to_num() 이중 방어
  * 레시피 캐싱: 속도 향상
  * TIS 정규화 저장
- GraphSAGE: 2-Layer SAGEConv로 32차원 임베딩 생성
- sampler.py: 네거티브 샘플링
  * Historical Hard Negative (2020-2023 이력 기반)
  * Random Negative
- loss.py: RiskAwareBCELoss
  * TIS 기반 Soft Label: 1.0 - (alpha × TIS)

[Phase 3 - 링크 예측]
- GraphSEAL: DGCNN 기반 구조적 링크 예측
  * 서브그래프 추출 및 DRNL 라벨링
  * Target edge 마스킹으로 Data Leakage 방지
- temporal_graph_builder.py: 시계열 그래프 구축
  * TGN용 이벤트 시퀀스 생성
- benchmarks.py: 휴리스틱 벤치마크
  * Common Neighbors (CN)
  * Adamic-Adar (AA)
  * Preferential Attachment (PA)

[핵심 알고리즘]
1. 생산함수 추정: Zero-shot learning 기반
2. 그래프 임베딩: GraphSAGE (Inductive learning)
3. 링크 예측: GraphSEAL (DGCNN) + 시계열 분석
4. 네거티브 샘플링: Historical Hard + Random
5. 손실 함수: TIS 기반 Risk-Aware BCE Loss 


# ============================================================
# 데이터 컬럼명
# ============================================================

[원본 거래 데이터 컬럼명]

1. 부가가치세 신고 데이터 기반 기업간 거래관계 데이터 (2015-2024년, 10년 데이터 존재)
    - *컬럼*
        
        `posco_network_capital_consumergoods_removed_{year}.csv` : 두 기업 간 거래 내역
        
        컬럼 95개 
        
        [사업자등록번호 관련 컬럼] 43개
        
        1. 사업자등록번호
        2. i_사업자_상품_대
        3. i_사업자_상품명_대
        4. 업체번호_사업자
        5. 업체명_사업자
        6. 대표_사업자등록번호
            - 업체번호가 가진 여러 개의 사업자등록번호 중 대표로 선정한 사업자등록번호(일반적으로는 본점 사업자등록번호를 선정)
        7. 대표_사업자유형코드_사업자
        8. 사업장명_사업자
        9. 법인_사업자
        10. 기업규모유형코드_사업자
        11. 그룹번호_사업자
        12. 기업주체유형코드_사업자
        13. 대표자세이프키_사업자
        14. 기업존속여부_사업자
        15. 종업원수_사업자
        16. 종업원수기준일자_사업자
        17. 상장시장유형코드_사업자
        18. 본사사업장일렬번호_사업자
        19. 지번주소_사업자
        20. X축POI좌표값_사업자
        21. Y축POI좌표값_사업자
        22. 주요상품목록_사업자
        23. 산업코드ID_사업자
        24. KSIC_추출_사업자
            - em001의 ‘산업코드ID’에서 KSIC코드의 알파벳(대분류)와 숫자 5개를 가져온 컬럼
        25. KSIC_숫자_원본_사업자
        26. IO_산업_매칭레벨_사업자
        27. IO_산업_중분류_코드_사업자
        28. IO산업_중분류_부문명_사업자
        29. IO산업_대분류_코드_사업자
        30. IO산업_대분류_부문명_사업자
        31. KSIC_숫자_new_사업자
            - ‘KSIC_추출’에서 숫자만 가져오고 해당 숫자가 11차에 없는 경우 11차로 변환한 컬럼
        32. IO상품_매칭레벨_사업자
        33. IO상품_다중_중분류_코드_사업자
        34. IO상품_다중_중분류_상품명_사업자
        35. IO상품_다중_대분류_코드_사업자
        36. IO상품_다중_대분류_상품명_사업자
        37. IO상품_단일_대분류_코드_사업자
        38. min_depth_사업자
            - 현대제철을 기준으로 한 사업자의 최소 연결 깊이(수요/공급 방향 구분하지 않음)
        39. group4_사업자
        - 현대제철과의 최소 연결 깊이에 따른 4단계 그룹 구분
            - 0 : 현대제철
            - 1 : 현대제철로부터 최소 깊이 1
            - 2 : 현대제철로부터 최소 깊이 2
            - 3 : 최소 깊이 3 이상 또는 연결되지 않은 사업자
        1. group3_사업자
            - 현대제철과의 최소 연결 깊이에 따른 3단계 그룹 구분
                - 0 : 현대제철
                - 1 : 현대제철로부터 최소 깊이 1
                - 2 : 최소 깊이 2 이상 또는 연결되지 않은 사업자
        2. 공급_min_depth_사업자
            - 현대제철이 구매하는 공급망 방향에서 최소 깊이
        3. 수요_min_depth_사업자
            - 현대제철이 판매하는 수요망 방향에서 최소 깊이
        4. 양방향여부_사업자
            - 공급·수요 min_depth가 모두 존재하면 True
        
        [거래처등록번호 관련 컬럼] 43개
        
        1. 거래처사업자등록번호
        2. i_거래처_상품_대
        3. i_거래처_상품명_대
        4. 업체번호_거래처
        5. 업체명_거래처
        6. 대표_거래처사업자등록번호
            - 업체번호가 가진 여러 개의 사업자등록번호 중 대표로 선정한 사업자등록번호(일반적으로는 본점 사업자등록번호를 선정)
        7. 대표_사업자유형코드_거래처
        8. 사업장명_거래처
        9. 법인_거래처
        10. 기업규모유형코드_거래처
        11. 그룹번호_거래처
        12. 기업주체유형코드_거래처
        13. 대표자세이프키_거래처
        14. 기업존속여부_거래처
        15. 종업원수_거래처
        16. 종업원수기준일자_거래처
        17. 상장시장유형코드_거래처
        18. 본사사업장일렬번호_거래처
        19. 지번주소_거래처
        20. X축POI좌표값_거래처
        21. Y축POI좌표값_거래처
        22. 주요상품목록_거래처
        23. 산업코드ID_거래처
        24. KSIC_추출_거래처
            - em001의 ‘산업코드ID’에서 KSIC코드의 알파벳(대분류)와 숫자 5개를 가져온 컬럼
        25. KSIC_숫자_원본_거래처
        26. IO_산업_매칭레벨_거래처
        27. IO_산업_중분류_코드_거래처
        28. IO산업_중분류_부문명_거래처
        29. IO산업_대분류_코드_거래처
        30. IO산업_대분류_부문명_거래처
        31. KSIC_숫자_new_거래처
            - ‘KSIC_추출’에서 숫자만 가져오고 해당 숫자가 11차에 없는 경우 11차로 변환한 컬럼
        32. IO상품_매칭레벨_거래처
        33. IO상품_다중_중분류_코드_거래처
        34. IO상품_다중_중분류_상품명_거래처
        35. IO상품_다중_대분류_코드_거래처
        36. IO상품_다중_대분류_상품명_거래처
        37. IO상품_단일_대분류_코드_거래처
        38. min_depth_거래처
            - 현대제철을 기준으로 한 거래처의 최소 연결 깊이(수요/공급 방향 구분하지 않음)
        39. group4_거래처
            - 현대제철과의 최소 연결 깊이에 따른 4단계 그룹 구분
                - 0 : 현대제철
                - 1 : 현대제철로부터 최소 깊이 1
                - 2 : 현대제철로부터 최소 깊이 2
                - 3 : 최소 깊이 3 이상 또는 연결되지 않은 거래처
        40. group3_거래처
            - 현대제철과의 최소 연결 깊이에 따른 3단계 그룹 구분
                - 0 : 현대제철
                - 1 : 현대제철로부터 최소 깊이 1
                - 2 : 최소 깊이 2 이상 또는 연결되지 않은 거래처
        41. 공급_min_depth_거래처
            - 현대제철이 구매하는 공급망 방향에서 최소 깊이
        42. 수요_min_depth_거래처
            - 현대제철이 판매하는 수요망 방향에서 최소 깊이
        43. 양방향여부_거래처
            - 공급·수요 min_depth가 모두 존재하면 True
        
        [거래 내역 관련 컬럼] 9개
        
        1. A_ij
        2. 총공급금액: 1년간 공급금액 총합
        3. 분기수: 총공급금액 계산에 들어간 분기 개수
        4. 공급금액평균: 총공급금액/총분기수
        5. 부가가치세신고연도
        6. 거래처_총판매_x
        7. 거래처_총구매_x
        8. 거래처_총판매_y
        9. 거래처_총구매_y
        10. ~~거래처_총판매: 거래처가 1년 동안 총 판매하는 금액; 전 거래처_총산출~~
        11. ~~거래처_총구매: 거래처가 1년 동안 총 구매하는 금액; 전 거래처_총공급~~
        
2. 개별 기업 데이터 (NICE 데이터에 있는 45만 개 법인, ksic 코드&IO 대분류 매핑)
    - *컬럼*
        
        `vat_20-24_company_list_w_companyinfo_cutoff_q1more_v3_hyundaisteel_hj.csv` 
        
        : 기업 정보 (나이스의 부가세신고서비스를 사용하지 않는 기업들도 포함. 결국 vat에 없는 기업들도 존재)
        
        [em001 원본 컬럼 & KSIC_추출]
        
        - 업체번호
        - 업체명
        - 그룹번허
        - 대표자세이프키
        - 종업원수
        - 종업원수기준일자
        - 기업존속여부
        - 기업규모유형코드
        - 기업주체유형코드
        - 대표자세이프키
        - 본사사업장일련번호
        - 사업장명
        - 지번주소
        - X축P0I좌표값
        - Y축P0I좌표값
        - 주요상품목록
        - 산업코드ID: 차수 + KSIC + 기타 로 구성된 코드
            - 예시1) 09C2411200
                - KSIC 09차 기준 C(제조업) + 24112(세세분류)에 속한 기업
            - 예시) 10C0000000
                - KSIC 10차 기준 C(제조업)에 속한 기업
        - KSIC_추출: 산업코드ID에서 알파벳 + `숫자5`자리 가져옴
            - A00000(대분류, 알파벳만 있는 경우)
            - A11000(중분류)
            - A11100(소분류)
            - A11110(세분류)
            - A11111(세세분류)
        
        [IO산업 관련 컬럼들]
        
        *IO산업은 상품 다중 매핑 단일로 선택하는 과정에 사용됨*
        
        - KSIC_숫자_원본: KSIC_추출에서 숫자 5자리만 가져옴; 숫자만 추출하는 이유: IO상품 - KSIC 매핑표가 숫자만 사용
            - 00000(대분류)
            - 11000(중분류)
            - 11100(소분류)
            - 11110(세분류)
            - 11111(세세분류)
            
            *IO산업은 KSIC_숫자_원본를 기준으로 매핑 진행*
            
        - IO산업_매칭레벨: ‘KSIC_숫자_원’ IO산업을 대분류, 중분류, 소분류, 세분류, 세세분류
            - 대분류: 0%  (92개 기업)
            - 중분류: 0.43%
            - 소분류: 4.51%
            - 세분류: 20.84%
            - 세세분류: 68.28%
        - IO산업_대분류_코드
        - IO산업_대분류_부문명
        - IO산업_중분류_코드
        - IO산업_중분류_부문명
        
        [IO상품 관련 컬럼들]
        
        - KSIC_숫자_new
        - IO상품_다중_중분류_코드
        - IO상품_다중_중분류_상품명
        - IO상품_다중_대분류_코드
        - IO상품_다중_대분류_상품명
        - IO상품_단일_대분류_코드
        
        [네트워크 관련 컬럼들]
        
        *무방향(수요 공급 방향 고려하지 않음)포스크와 깊이를 나타낸 컬럼들*
        
        - min_depth
        - group3
        - group4
        - 공급_min_depth
        - 수요_min_depth
        - 양방향여부
        
3. 개별 기업의 수출액
    - *컬럼*
        
        export_value_estimation_final.csv
        [’업체번호’, ‘export_value’]
        
4. 개별 기업의 총매출액
    - *추정 진행 : [[데이터 2] 총매출액 추정](https://www.notion.so/2-2dcf5a45ece2803da81ae04419a1ab86?pvs=21)*
        
        final_tg_2024_estimation.csv
        [’업체번호’, ‘tg_2024’, ‘tg_2024_final’, ‘tg_2024_predicted’, ‘is_predicted’]
        
5. 개별 기업의 소재지 (기업 간 거리가 가까울수록 거래관계일 확률이 올라감)
    
    *출처: [Production Networks, Geography, and Firm Performance](https://www.notion.so/Production-Networks-Geography-and-Firm-Performance-2a1f5a45ece28027ae96cb3c1bcb9295?pvs=21)* 
    
    → 부가가치세 신고 데이터에 좌표정보 존재
    
6. 개별 기업의 자산 추정액
    - *추정 진행: [[데이터 3] 자산 추정](https://www.notion.so/3-2e1f5a45ece2803a9447dceea4fef34e?pvs=21)*
        
        컬럼: [’업체번호’ ,’자산추정_2024’]
        
7. 개별 기업의 수출 추정액
    - 컬럼
        
        컬럼: [’업체번호’, ‘수출액_통합’]
        
        - 업체번호가 없는 경우는 수출을 하지 않는 업체로 봐서 수출액_통합을 0으로 입력